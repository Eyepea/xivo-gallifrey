#! /bin/sh /usr/share/dpatch/dpatch-run
## 99_CVE-2006-2898.dpatch by Joey Schulze <joey@debian.org>
##
## DP: Bug in the IAX2 channel allows remote attackers to craft
## DP: a denial of service.

@DPATCH@
Index: asterisk-1.2.23~dfsg/channels/chan_iax2.c
===================================================================
--- asterisk-1.2.23~dfsg.orig/channels/chan_iax2.c	2007-08-06 12:01:32.000000000 +0200
+++ asterisk-1.2.23~dfsg/channels/chan_iax2.c	2007-08-06 12:01:41.000000000 +0200
@@ -6598,7 +6598,7 @@
 	if (iaxdebug && (res >= sizeof(*fh)))
 		iax_showframe(NULL, fh, 1, &sin, res - sizeof(*fh));
 #endif
-	if (ntohs(mh->callno) & IAX_FLAG_FULL) {
+	if ((res >= sizeof(*fh)) && ntohs(mh->callno) & IAX_FLAG_FULL) {
 		if (res < sizeof(*fh)) {
 			ast_log(LOG_WARNING, "Rejecting packet from '%s.%d' that is flagged as a full frame but is too short\n", ast_inet_ntoa(iabuf, sizeof(iabuf), sin.sin_addr), ntohs(sin.sin_port));
 			return 1;
