#! /bin/sh /usr/share/dpatch/dpatch-run
## sys_readline.dpatch by Tzafrir Cohen <tzafrir.cohen@xorcom.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Use readline for the CLI. partially works.

@DPATCH@
diff -urNad asterisk-1.2.9.1.dfsg/asterisk.c /tmp/dpep.eom8T2/asterisk-1.2.9.1.dfsg/asterisk.c
--- asterisk-1.2.9.1.dfsg/asterisk.c	2006-08-11 10:31:42.000000000 +0300
+++ /tmp/dpep.eom8T2/asterisk-1.2.9.1.dfsg/asterisk.c	2006-08-11 10:28:15.000000000 +0300
@@ -114,7 +114,12 @@
 #include "asterisk/file.h"
 #include "asterisk/io.h"
 #include "asterisk/lock.h"
+#ifdef SYS_READLINE
+#include <readline/readline.h>
+#include <readline/history.h>
+#else  /* SYS_READLINE */
 #include "editline/histedit.h"
+#endif /* SYS_READLINE */
 #include "asterisk/config.h"
 #include "asterisk/version.h"
 #include "asterisk/linkedlists.h"
@@ -198,17 +203,23 @@
 time_t ast_startuptime;
 time_t ast_lastreloadtime;
 
+#ifdef SYS_READLINE
+static const char * rl_readline_name = "asterisk";
+#else
 static History *el_hist = NULL;
 static EditLine *el = NULL;
+#endif /* SYS_READLINE */
 static char *remotehostname;
 
 struct console consoles[AST_MAX_CONNECTS];
 
 char defaultlanguage[MAX_LANGUAGE] = DEFAULT_LANGUAGE;
 
+#ifndef SYS_READLINE
 static int ast_el_add_history(char *);
 static int ast_el_read_history(char *);
 static int ast_el_write_history(char *);
+#endif /* SYS_READLINE */
 
 char ast_config_AST_CONFIG_DIR[AST_CONFIG_MAX_PATH];
 char ast_config_AST_CONFIG_FILE[AST_CONFIG_MAX_PATH];
@@ -719,6 +730,15 @@
 		ast_log(LOG_WARNING, "Unable to create socket: %s\n", strerror(errno));
 		return 0;
 	}
+#ifdef SYS_READLINE
+	/* If we use readline, we'll use its main loop, and non-blocking 
+	 * reads */
+	if (0 != fcntl(ast_consock, F_SETFL, O_NONBLOCK)) {
+		ast_log(LOG_WARNING, "Unable to set socket non-blocking: %s\n",
+				strerror(errno));
+		return 0;
+	}
+#endif
 	memset(&sunaddr, 0, sizeof(sunaddr));
 	sunaddr.sun_family = AF_LOCAL;
 	ast_copy_string(sunaddr.sun_path, (char *)ast_config_AST_SOCKET, sizeof(sunaddr.sun_path));
@@ -891,11 +911,15 @@
 		if (getenv("HOME")) 
 			snprintf(filename, sizeof(filename), "%s/.asterisk_history", getenv("HOME"));
 		if (!ast_strlen_zero(filename))
+#ifdef SYS_READLINE
+			write_history(filename);	
+#else /* SYS_READLINE */
 			ast_el_write_history(filename);
 		if (el != NULL)
 			el_end(el);
 		if (el_hist != NULL)
 			history_end(el_hist);
+#endif /* SYS_READLINE */
 	}
 	if (option_verbose)
 		ast_verbose("Executing last minute cleanups\n");
@@ -1003,7 +1027,11 @@
 	fflush(stdout);
 	/* Called when readline data is available */
 	if (s && !ast_all_zeros(s))
+#ifdef SYS_READLINE
+		add_history(s);
+#else /* SYS_READLINE */
 		ast_el_add_history(s);
+#endif /* SYS_READLINE */
 	/* Give the console access to the shell */
 	if (s) {
 		/* The real handler for bang */
@@ -1023,7 +1051,11 @@
 	int ret = 0;
 	/* Called when readline data is available */
 	if (s && !ast_all_zeros(s))
+#ifdef SYS_READLINE
+		add_history(s);
+#else /* SYS_READLINE */
 		ast_el_add_history(s);
+#endif /* SYS_READLINE */
 	/* Give the console access to the shell */
 	if (s) {
 		/* The real handler for bang */
@@ -1255,7 +1287,73 @@
 #endif /* ! LOW_MEMORY */
 };
 
+
+static void attempt_reconnect(void) 
+{
+	int tries;
+	int reconnects_per_second = 20;
+	fprintf(stderr, "Attempting to reconnect for 30 seconds\n");
+	for (tries=0;tries<30 * reconnects_per_second;tries++) {
+		if (ast_tryconnect()) {
+			fprintf(stderr, "Reconnect succeeded after %.3f seconds\n", 1.0 / reconnects_per_second * tries);
+			printf(term_quit());
+			WELCOME_MESSAGE;
+			break;
+		} else {
+			usleep(1000000 / reconnects_per_second);
+		}
+	}
+	if (tries >= 30 * reconnects_per_second) {
+		fprintf(stderr, "Failed to reconnect for 30 seconds.  Quitting.\n");
+		quit_handler(0, 0, 0, 0);
+	}
+}
+
+/* Called by readline every 0.1 seconds or so from its main loop. */
+static int ast_rl_event_hook(void) 
+{
+#ifdef SYS_READLINE
+	int res;
+	char buf[512];
+
+	res = read(ast_consock, buf, sizeof(buf) - 1);
+	/* if the remote side disappears exit */
+	if ((res == -1) && (errno == EAGAIN))
+		return 0; /* There was nothing to read. Maybe next time. */
+	
+	if (res < 1) {
+		fprintf(stderr, "\nDisconnected from Asterisk server: %s.\n",
+			strerror(errno));
+		if (!option_reconnect) {
+			quit_handler(0, 0, 0, 0);
+		} else {
+			attempt_reconnect();
+		}
+		/* never reached */
+	}
+
+	buf[res] = '\0';
+
+	/* Let's assume we always get complete lines in read-s */
+	fputc('\r', rl_outstream); /* to beginning of line... */
+	/* suppress an excessive linefeed: */
+	fputs(buf, rl_outstream);     /* The text itself         */
+	if (option_exec)
+		return 0;
+	/* and refresh readline's prompt */
+	rl_forced_update_display();
+	
+	return 0;
+#endif
+}
+
+#ifdef SYS_READLINE
+/* TODO: this #define means we're doing something wrong. */
+#define CC_REFRESH 4
+static int ast_rl_read_char(char *cp)
+#else
 static int ast_el_read_char(EditLine *el, char *cp)
+#endif
 {
 	int num_read=0;
 	int lastpos=0;
@@ -1334,13 +1432,15 @@
 	return (0);
 }
 
-static char *cli_prompt(EditLine *el)
+static char *cli_prompt(void)
 {
 	static char prompt[200];
 	char *pfmt;
 	int color_used=0;
 	char term_code[20];
 
+	if (option_exec)
+		return "";
 	if ((pfmt = getenv("ASTERISK_PROMPT"))) {
 		char *t = pfmt, *p = prompt;
 		memset(prompt, 0, sizeof(prompt));
@@ -1479,6 +1579,45 @@
 	return(prompt);	
 }
 
+#ifdef SYS_READLINE
+#define AST_RL_COMPL_BUFLEN (2048)
+static char* ast_rl_completion_function(const char *text, int state)
+{
+	char buf[AST_RL_COMPL_BUFLEN];
+	int len, res;
+	char *resbuf;
+
+	//fprintf(stderr, "\nINPUT:  %3d, \"%s\"\n", state, text);
+	if (! option_remote )
+		return ast_cli_generator(rl_line_buffer, (char*)text, state);
+
+	/* option_remote is set */
+	snprintf(buf, sizeof(buf),"_command complete \"%s\" \"%s\" %d", 
+			rl_line_buffer, text, state); 
+	//fprintf(stderr, "\nSEND:        \"%s\"\n", buf);
+	fdprint(ast_consock, buf);
+	res = read(ast_consock, buf, sizeof(buf));
+	if (res <= 0) {
+		//fprintf(stderr,"\nREAD ERROR: %d, (%d: %s)\n",
+		//		res, errno, strerror(errno));
+		return NULL;
+        }
+	buf[res] = '\0';
+	if (! strncmp(buf,"NULL\n",5))
+		return NULL;
+	if (buf[0] == '\0')
+		return NULL;
+	//fprintf(stderr, "\nGOT:    %3d, \"%s\"\n", res, buf);
+	
+	/* buf now contains the result word */
+	len = strlen(buf)+1;
+	resbuf = malloc(len);
+	if (!resbuf)
+		return NULL;
+	ast_copy_string(resbuf, buf, len);
+	return resbuf;
+}
+#else /* SYS_READLINE */
 static char **ast_el_strtoarr(char *buf)
 {
 	char **match_list = NULL, *retstr;
@@ -1756,6 +1895,23 @@
 
 	return ret;
 }
+#endif /* SYS_READLINE */
+
+static void ast_rl_initialize(void) 
+{
+	static int initilized = 0;
+	/* ignore races for the moment */
+	if (!initilized) {
+		rl_initialize();
+		//rl_set_prompt(cli_prompt());
+		rl_readline_name = cli_prompt();
+		rl_event_hook = ast_rl_event_hook;
+		//rl_attempted_completion_function = ast_rl_completion_function;
+		rl_completion_entry_function = ast_rl_completion_function;
+		//fprintf(stderr, "===INITILIZING READLINE==[%s]====\n", cli_prompt());
+		initilized = 1;
+	}
+}
 
 static void ast_remotecontrol(char * data)
 {
@@ -1770,7 +1926,7 @@
 	char *stringp=NULL;
 
 	char *ebuf;
-	int num = 0;
+	//int num = 0;
 
 	read(ast_consock, buf, sizeof(buf));
 	if (data)
@@ -1795,6 +1951,9 @@
 	remotehostname = hostname;
 	if (getenv("HOME")) 
 		snprintf(filename, sizeof(filename), "%s/.asterisk_history", getenv("HOME"));
+#ifdef SYS_READLINE
+	ast_rl_initialize();
+#else /* SYS_READLINE */
 	if (el_hist == NULL || el == NULL)
 		ast_el_initialize();
 
@@ -1802,7 +1961,8 @@
 
 	if (!ast_strlen_zero(filename))
 		ast_el_read_history(filename);
-
+#endif /* SYS_READLINE */
+	
 	if (option_exec && data) {  /* hack to print output then exit if asterisk -rx is used */
 		char tempchar;
 #ifdef __Darwin__
@@ -1814,12 +1974,20 @@
 			ast_el_read_char(el, &tempchar);
 		}
 #else
+#ifdef SYS_READLINE
+		while (!ast_rl_read_char(&tempchar));
+#else /* SYS_READLINE */
 		while (!ast_el_read_char(el, &tempchar));
+#endif /* SYS_READLINE */
 #endif
 		return;
 	}
 	for(;;) {
+#ifdef SYS_READLINE
+		ebuf = readline(cli_prompt());
+#else /* SYS_READLINE */
 		ebuf = (char *)el_gets(el, &num);
+#endif /* SYS_READLINE */
 
 		if (!ast_strlen_zero(ebuf)) {
 			if (ebuf[strlen(ebuf)-1] == '\n')
@@ -2029,7 +2197,7 @@
 	int x;
 	FILE *f;
 	sigset_t sigs;
-	int num;
+	//int num;
 	int is_child_of_nonroot=0;
 	char *buf;
 	char *runuser=NULL, *rungroup=NULL;
@@ -2227,6 +2395,10 @@
 			ast_log(LOG_WARNING, "Unable to initialize supplementary group list for %s\n", runuser);
 			exit(1);
 		}
+		if (!rungroup && initgroups(runuser, pw->pw_gid)) {
+			ast_log(LOG_WARNING, "Unable to initialize supplementary group list for %s\n", runuser);
+			exit(1);
+		}
 		if (setuid(pw->pw_uid)) {
 			ast_log(LOG_WARNING, "Unable to setuid to %d (%s)\n", (int)pw->pw_uid, runuser);
 			exit(1);
@@ -2260,11 +2432,15 @@
 	
 
 	if (option_console) {
+#ifdef SYS_READLINE
+		ast_rl_initialize();
+#else
 		if (el_hist == NULL || el == NULL)
 			ast_el_initialize();
 
 		if (!ast_strlen_zero(filename))
 			ast_el_read_history(filename);
+#endif /* SYS_READLINE */
 	}
 
 	if (ast_tryconnect()) {
@@ -2442,7 +2619,8 @@
 		set_title(title);
 
 		for (;;) {
-			buf = (char *)el_gets(el, &num);
+			//buf = (char *)el_gets(el, &num);
+			buf = readline(cli_prompt());
 			if (buf) {
 				if (buf[strlen(buf)-1] == '\n')
 					buf[strlen(buf)-1] = '\0';
diff -urNad asterisk-1.2.9.1.dfsg/cli.c /tmp/dpep.eom8T2/asterisk-1.2.9.1.dfsg/cli.c
--- asterisk-1.2.9.1.dfsg/cli.c	2006-08-11 10:31:41.000000000 +0300
+++ /tmp/dpep.eom8T2/asterisk-1.2.9.1.dfsg/cli.c	2006-08-11 10:31:45.000000000 +0300
@@ -44,7 +44,15 @@
 #include "asterisk/utils.h"
 #include "asterisk/lock.h"
 /* For rl_filename_completion */
+#ifndef SYS_READLINE
 #include "editline/readline/readline.h"
+#else
+#  ifdef SYS_READLINE_EDIT
+#    include <editline/readline.h>
+#  else
+#    include <readline/readline.h>
+#  endif
+#endif
 /* For module directory */
 #include "asterisk/version.h"
 
diff -urNad asterisk-1.2.9.1.dfsg/Makefile /tmp/dpep.eom8T2/asterisk-1.2.9.1.dfsg/Makefile
--- asterisk-1.2.9.1.dfsg/Makefile	2006-08-11 10:31:42.000000000 +0300
+++ /tmp/dpep.eom8T2/asterisk-1.2.9.1.dfsg/Makefile	2006-08-11 10:31:45.000000000 +0300
@@ -306,7 +306,11 @@
 
 endif # WITHOUT_ZAPTEL
 
-LIBEDIT=editline/libedit.a
+#LIBEDIT=editline/libedit.a
+#LIBS+=-ledit
+LIBS+=-lreadline
+ASTCFLAGS+=-DSYS_READLINE
+#ASTCFLAGS+=-DSYS_READLINE_EDIT
 
 ifneq ($(wildcard .version),)
   ASTERISKVERSION:=$(shell cat .version)
@@ -511,7 +515,7 @@
 cygwin_a:
 	$(MAKE) -C cygwin all
 
-asterisk: $(CYGLOADER) editline/libedit.a db1-ast/libdb1.a stdtime/libtime.a $(OBJS)
+asterisk: $(CYGLOADER) db1-ast/libdb1.a stdtime/libtime.a $(OBJS)
 	build_tools/make_build_h > include/asterisk/build.h.tmp
 	if cmp -s include/asterisk/build.h.tmp include/asterisk/build.h ; then echo ; else \
 		mv include/asterisk/build.h.tmp include/asterisk/build.h ; \
