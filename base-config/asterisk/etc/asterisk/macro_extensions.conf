[macro-features]
exten = s,1,Answer
exten = s,n,Set(USER=${CALLERID(num)})
exten = s,n,Wait(0.5)
exten = s,n,Macro(setval,ONOFF,${ARG1},Feature)
exten = s,n,GotoIf(${ONOFF}?off:on)
exten = s,n(on),GotoIf(${ARG4}?off)
exten = s,n,Set(DB(users/${USER}/${ARG1})=1)
exten = s,n,Playback(${ARG2})
exten = s,n,Hangup
exten = s,n(off),Set(DB(users/${USER}/${ARG1})=0)
exten = s,n,Playback(${ARG3})
exten = s,n,Hangup

[macro-setval]
exten = s,1,Set($[${ARG1}]=${DB(users/${USER}/${ARG2})})
exten = s,n,Noop(Verification de la clef : users/${USER}/${ARG2})
exten = s,n,Noop(${ARG3}: ${${ARG1}})
exten = s,n,Noop(${USER})

[macro-getval]
exten = s,1,Set($[${ARG1}]=${DB(${ARG2})})
exten = s,n,Noop(Verification de la clef : ${ARG2})
exten = s,n,Noop(${ARG3}: ${${ARG1}})

[macro-superuser]
exten = s,1,Wait(0.5)
exten = s,n,AGI(userfeatures,${MACRO_EXTEN})
exten = s,n,Macro(whocall,${CALLERID(num)},${MACRO_EXTEN})
exten = s,n,AGI(xivo_push|127.0.0.1|12347|${PROTO}|${MACRO_EXTEN}|${CALLERID(num)}|${CALLTYPE})
exten = s,n,Set(USER=${MACRO_EXTEN})
exten = s,n,Set(GROUP()=${USER})
exten = s,n,GotoIf($[ "${PROTO}" : "(sip|iax)" ]?box:nobox)
exten = s,n(nobox),Set(MAILBOX=0)
exten = s,n,Goto(status)
exten = s,n(box),GotoIf($[ "${PROTO}" = "sip" ]?sip:iax)
exten = s,n(sip),Set(MAILBOX=${SIPPEER(${NAME}:mailbox)})
exten = s,n,Goto(status)
exten = s,n(iax),Set(MAILBOX=${IAXPEER(${NAME}:mailbox)})
exten = s,n(status),GotoIf($["${STATUS}" = "1"]?VMB)
exten = s,n,GotoIf($["${STATUS}" = "2"]?VMU)
exten = s,n,Gotoif(${FUStatus}?FU)
exten = s,n,Gotoif(${DND}?DND)
exten = s,n,Gotoif(${RCStatus}?Record:NoRecord)
exten = s,n(Record),Monitor(wav)
exten = s,n(NoRecord),Noop(No record)
exten = s,n,GotoIf(${CALLTIME}?TIME:NOTIME)
exten = s,n(TIME),Set(TIMEOUT(absolute)=${CALLTIME})
exten = s,n(NOTIME),GotoIf(${MOH}?MOH:NOMOH)
exten = s,n(MOH),Set(MUSICCLASS()=${MOH}) 
exten = s,n(NOMOH),GotoIf($["${GROUP_COUNT(${MACRO_EXTEN})}" > "${NBC}"]?VMB)
exten = s,n,Gotoif(${CSStatus}?Screen:NoScreen)
exten = s,n,NoOp(Recorded file : ${RECORDED_FILE})
exten = s,n(Screen),Dial(${PROTO}/${NAME},${NBS},ptTwW)
exten = s,n,GotoIf(${CALLGROUP}?BREAK)
exten = s,n,Goto(${DIALSTATUS})
exten = s,n(NoScreen),Dial(${PROTO}/${NAME},${NBS},tTwW)
exten = s,n,GotoIf(${CALLGROUP}?BREAK)
exten = s,n,GotoIf(${QUEUENAME}?QUEUE:VMB)
exten = s,n(QUEUE),Queue(${QUEUENAME},rn)
exten = s,n,Goto(${DIALSTATUS})
exten = s,n,Hangup()

; Dial Status 
exten = s,n(NOANSWER),GotoIf(${VMStatus}?:NoMail)
exten = s,n,GotoIf(${FRStatus}?FR)
exten = s,n,GotoIf($[${GROUP_COUNT("${USER}")} > 1 ]?VMB:VMU)

exten = s,n(ANSWER),Hangup()

exten = s,n(CANCEL),Hangup()

exten = s,n(DONTCALL),Playback(fr/extra/user-invalid)
exten = s,n,Hangup()

exten = s,n(CONGESTION),GotoIf(${VMStatus}?VMB:NoMail)

exten = s,n(TORTURE),Goto(torture,s,1)

exten = s,n(CHANUNAVAIL),Playback(fr/extra/user-invalid)
exten = s,n,Congestion(5)
exten = s,n,Hangup()

exten = s,n(BUSY),GotoIf(${FBStatus}?FB)
exten = s,n,Goto(VMB)

exten = s,n(DND),GotoIf(${VMStatus}?VMU)
exten = s,n,Goto(NoMail)

exten = s,n(FU),Set(FWDNumber=${FUNumber})
exten = s,n,Goto(Forward)

exten = s,n(FB),Set(FWDNumber=${FBNumber})
exten = s,n,Goto(Forward)

exten = s,n(FR),Set(FWDNumber=${FRNumber})
exten = s,n,Goto(Forward)

exten = s,n(Forward),Set(FWDContext=${MACRO_CONTEXT})
exten = s,n(Forward),Dial(Local/${FWDNumber}@${FWDContext})

exten = s,n(DND),GotoIf(${VMStatus}?VMU)

exten = s,n(NoMail),Answer()
exten = s,n,Wait(0.5)
exten = s,n,Playback(fr/extra/user-invalid)
exten = s,n,Hangup()

exten = s,n(VMU),GotoIf(${MAILBOX}?:NoMail)
exten = s,n,Answer()
exten = s,n,Wait(0.5)
exten = s,n,VoiceMail(${MAILBOX},u)
exten = s,n,Hangup()

exten = s,n(VMB),GotoIf(${MAILBOX}?:NoMail)
exten = s,n,Answer()
exten = s,n,Wait(0.5)
exten = s,n,VoiceMail(${MAILBOX},b)
exten = s,n,Hangup()

exten = s,n(BREAK),NoOp(break)

exten = a,1,NoOp(### Consultation Voicemail ${MAILBOX})
exten = a,n,VoiceMailMain(${MAILBOX})
exten = a,n,Hangup()


exten = i,1,Playback(fr/extra/user-invalid)
exten = i,n,Hangup()

exten = h,1,Hangup()

exten = T,1,NoOp(Call is finished because timeout is finished)
exten = T,n,Playback(vm-goodbye)

[macro-supergroup]
exten = s,1,AGI(groupfeatures,${MACRO_EXTEN})
exten = s,n,Set(__CALLGROUP=1)
exten = s,n,GotoIf(${EXT}?CALLGROUP)
exten = s,n,Playback(fr/extra/user-invalid)
exten = s,n,Hangup()
exten = s,n(CALLGROUP),Queue(${GNAME},r)
exten = s,n,Hangup()

[macro-callgroup]
exten = s,1,AGI(callgroup|${ARG1})
exten = s,n,Noop(STANDARD => ${STANDARD})
exten = s,n,Dial(${STANDARD},20,wWtT)
exten = s,n,Goto(local-extensions,standard,1)
exten = s,n,Hangup

[macro-setcallerid]
exten = s,1,Set(USER=${ARG1})
exten = s,n,Set(CALLERID(num)=${NUMERO})
exten = s,n,Macro(setval,ON,ON,Out Number)
exten = s,n,GotoIf(${ON}?ON:DIAL)
exten = s,n,Noop(Souhaite un callerid specifique)
exten = s,n(ON),Set(CALLERID(num)=${ON})
exten = s,n(DIAL),Noop(Caller ID : ${CALLERID(num)})

[macro-analog]
exten = s,1,Noop(Arrivee sur une ligne analogique)
exten = s,n,Dial(Zap/${ARG1})
exten = s,n,Hangup

[macro-faxreceive]
exten = s,1,Set(FAXNUMBER=${ARG1})
exten = s,n,Set(FAXFILE=/var/spool/asterisk/fax/${UNIQUEID}.tif)
exten = s,n,rxfax(${FAXFILE})
exten = s,n,system(/usr/share/asterisk/bin/faxtomail ${FAXNUMBER} ${FAXFILE} ${CALLERID(num)})
exten = s,n,Hangup

[macro-standard]
exten = s,1,Answer()
exten = s,n,Wait(1)
exten = s,n,NoOp(Appel standard)
exten = s,n,Macro(getval,StandEX,global/standard/exten,Extension Standard)
exten = s,n,Macro(getval,StandOP,global/standard/open,Standard is Open)
exten = s,n,Macro(getval,StandTI,global/standard/time,Time for Standard)
exten = s,n,GotoIf($["${StandOP}" = "1"]?open:close)
exten = s,n(open),Dial(SIP/${StandEX})
exten = s,n(close),Hangup()

[macro-musiqueattente]
exten = s,1,Answer()
exten = s,n,Wait(0.5)
exten = s,n,NoOp(Recuperation de la nouvelle musique attente)
exten = s,n,Authenticate(1234)
exten = s,n,Record(/usr/share/asterisk/moh/upload/musiqueattente.wav)
exten = s,n,System(/usr/sbin/asterisk -rx "moh reload")
exten = s,n,MusicOnHold(upload)
exten = s,n,Hangup()

[macro-whocall]
exten = s,1,Set(LENNUM=${LEN(${ARG1})})
exten = s,n,AGI(getsonnerie,${ARG2})
exten = s,n,GotoIf($[ ${GROUP_COUNT(${ARG2})} != 0]?:beep)
exten = s,n,Macro(nobeep)
exten = s,n,Goto(break)
exten = s,n(beep),GotoIf($[ "${CALLGROUP}" = "1" ]?group:nogroup)
exten = s,n(nogroup),GotoIf($[ ${LENNUM} < 6 ]?interne:externe)
exten = s,n(interne),NoOp(Appel interne : ${ARG1})
exten = s,n,Set(CALLTYPE=Appel interne)
exten = s,n,SIPAddHeader("Alert-Info:<http://www.proformatique.com>\;info=${RINGINTERNAL}")
exten = s,n,Goto(break)
exten = s,n(externe),NoOp(Appel externe : ${ARG1})
exten = s,n,Set(CALLTYPE=Appel externe)
exten = s,n,SIPAddHeader("Alert-Info:<http://www.proformatique.com>\;info=${RINGEXTERNAL}")
exten = s,n,Goto(break)
exten = s,n(group),NoOp(Appel de groupe : ${ARG1})
exten = s,n,Set(CALLTYPE=Appel de groupe)
exten = s,n,SIPAddHeader("Alert-Info:<http://www.proformatique.com>\;info=${RINGGROUP}")
exten = s,n,Goto(break)

exten = s,n(break),NoOp(Break)

[macro-nobeep]
exten = s,1,GotoIf(${ISTHOMSON}?:break)
exten = s,n,SIPAddHeader("Alert-Info:<http://www.proformatique.com>\;info=Silent")

exten = s,n(break),NoOp(Break)

[macro-supermeetme]
exten = s,1,MeetMe(${MACRO_EXTEN})

[macro-page]
exten = s,1,Set(_ALERT_INFO="RA")
exten = s,n,SipAddHeader("Call-Info:\<sip:proformatique.com\>\;Answer-After=0")

[macro-superdid]
exten = s,1,NoOp(${MACRO_EXTEN})
exten = s,n,AGI(did,${MACRO_EXTEN})

[macro-superout]
; numero speciaux
; num√©ro d'urgence
exten = s,1,AGI(outfeatures)
exten = s,n,GotoIf($[ ${USEZEROFOROUT} = 'yes' ]?:nosetzero)
exten = s,n,Set(CALLNUM=${MACRO_EXTEN:1})
exten = s,n(nosetzero),GotoIf($[ ${USEVOIPFOROUT} = 'yes' ]?:nousevoip)
exten = s,n,Set(TECH=${CHANVOIP})
exten = s,n(nousevoip),GotoIf($[ ${SETCALLERID} = 'yes' ]?:nosetcallerid)
exten = s,n,Set(CALLERID(num)=${EXTENNUM})
exten = s,n(nosetcallerid),GotoIf($[ ${MACRO_EXTEN)} : ${EMERGENCYNUMBER} ]?:noemergency)
exten = s,n,Dial(${CHANISDN}/${MACRO_EXTEN})
exten = s,n,Goto(break,1)
exten = s,n(noemergency),GotoIf($[ ${USEENUM} = 'yes' ]?:nouseenum)
exten = s,n,Set(ENUM=${ENUMLOOKUP(+33${CALLNUM},ALL,1,e164.org)})
exten = s,n,GotoIf(${ENUM}?:nouseenum)
exten = s,n,Set(TECH=${CUT(ENUM,:,1)})
exten = s,n,Set(CALLNUM=${CUT(ENUM,:,2)})
exten = s,n(nouseenum),Dial(${TECH}/33${CALLNUM})
exten = s,n,Goto(break,1)

exten = break,1,NoOp(Break!)
exten = break,n,Hangup()
