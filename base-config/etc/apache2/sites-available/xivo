
# Used for stats/monitoring
ExtendedStatus On

NameVirtualHost *:443

<VirtualHost *:443>
	SSLEngine on
	SSLOptions +FakeBasicAuth +StrictRequire +StdEnvVars +ExportCertData
	SSLProtocol all
	SSLCipherSuite RSA:!EXP:!NULL:+HIGH:+MEDIUM:-LOW
	SSLCertificateFile /etc/apache2/cert/server.crt
	SSLCertificateKeyFile /etc/apache2/cert/server.key
	SSLCACertificatePath /etc/ssl/certs/
	SSLCACertificateFile /etc/ssl/certs/proformatique.crt
	SSLVerifyClient none

	Include "/usr/share/pf-xivo-web-interface/apache.conf"
</VirtualHost>


NameVirtualHost *:8667

<VirtualHost *:8667>
	DocumentRoot /tftpboot/

	ErrorLog /var/log/apache2/xivo_error_provi_http.log
	CustomLog /var/log/apache2/xivo_access_provi_http.log combined

	<Directory />
		Options FollowSymLinks
		AllowOverride None
	</Directory>
</VirtualHost>

NameVirtualHost *:80

<VirtualHost *:80>
	RewriteEngine On

	# Used for Aastra phones first provisioning
	RewriteCond %{HTTP_USER_AGENT} !^Aastra5[1357]i
	RewriteRule ^/provisioning/Aastra/ - [L,R=403]

	RewriteCond %{HTTP_USER_AGENT} ^Aastra5([1357])i
	RewriteRule ^/(5[1357]i\.st)$ /provisioning/Aastra/$1 [PT,L]

	RewriteCond %{HTTPS} off
	# XXX Snom phones don't work with SSL
	RewriteCond %{HTTP_USER_AGENT} !snom3[026]0-
	# Used for Aastra phones provisioning
	RewriteCond %{REQUEST_URI} !^/provisioning/Aastra/
	# Used for stats/monitoring
	RewriteCond %{REQUEST_URI} !^/server-status$
	RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

	<Location />
		Deny from all
	</Location>

	# Used for Aastra phones provisioning
	Alias /provisioning/Aastra/ /tftpboot/Aastra/
	<Location /provisioning/Aastra/>
		Allow from all
	</Location>

	# Used for Snom phones
	<Location /service/ipbx/web_services.php/phonebook/search>
		Allow from all
	</Location>

	# Used for stats/monitoring
	<Location /server-status>
		SetHandler server-status
		Order deny,allow
		Deny from all
		Allow from 127.0.0.1
	</Location>

	Include "/usr/share/pf-xivo-web-interface/apache.conf"
</VirtualHost>
