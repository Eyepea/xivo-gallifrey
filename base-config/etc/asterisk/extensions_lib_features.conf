; XIVO Dialplan
; Copyright (C) 2006, 2007, 2008  Proformatique <technique@proformatique.com>
;
; This program is free software; you can redistribute it and/or modify
; it under the terms of the GNU General Public License as published by
; the Free Software Foundation; either version 2 of the License, or
; (at your option) any later version.
;
; This program is distributed in the hope that it will be useful,
; but WITHOUT ANY WARRANTY; without even the implied warranty of
; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
; GNU General Public License for more details.
;
; You should have received a copy of the GNU General Public License along
; with this program; if not, write to the Free Software Foundation, Inc.,
; 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

[macro-recsnd]
exten = s,1,Macro(pickup,0)
exten = s,n,Playback(record-message-after-beep)
exten = s,n,Record(${CALLERID(num)}-${EPOCH}.${ARG1})
exten = s,n,Wait(1)
exten = s,n,Playback(${RECORDED_FILE})
exten = s,n,Hangup()

[macro-phonestatus_say_enabled_disabled]
exten = s,1,Playback(${ARG1})
exten = s,n,GotoIf(${ARG2}?enabled,1:disabled,1)

exten = enabled,1,Playback(on)
exten = enabled,n,GotoIf(${ARG3}?to,1)

exten = to,1,Playback(to)
exten = to,n,SayDigits(${ARG3})

exten = disabled,1,Playback(off)

; TODO: say something smarter if no feature has been enabled.
[macro-phonestatus]
exten = s,1,AGI(agi://127.0.0.1/phonestatus)
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(status-phone)
exten = s,n,GotoIf($["${XIVO_ENABLEUNC}"=""]?$[${PRIORITY} + 2])
exten = s,n,Macro(phonestatus_say_enabled_disabled,forward-inc,${XIVO_ENABLEUNC},${XIVO_DESTUNC})
exten = s,n,GotoIf($["${XIVO_ENABLEBUSY}"=""]?$[${PRIORITY} + 2])
exten = s,n,Macro(phonestatus_say_enabled_disabled,forward-busy,${XIVO_ENABLEBUSY},${XIVO_DESTBUSY})
exten = s,n,GotoIf($["${XIVO_ENABLERNA}"=""]?$[${PRIORITY} + 2])
exten = s,n,Macro(phonestatus_say_enabled_disabled,forward-rna,${XIVO_ENABLERNA},${XIVO_DESTRNA})
exten = s,n,GotoIf($["${XIVO_ENABLEVOICEMAIL}"=""]?$[${PRIORITY} + 2])
exten = s,n,Macro(phonestatus_say_enabled_disabled,vm-status,${XIVO_ENABLEVOICEMAIL})
exten = s,n,GotoIf($["${XIVO_CALLFILTER}"=""]?$[${PRIORITY} + 2])
exten = s,n,Macro(phonestatus_say_enabled_disabled,screening-status,${XIVO_CALLFILTER})
exten = s,n,GotoIf($["${XIVO_CALLRECORD}"=""]?$[${PRIORITY} + 2])
exten = s,n,Macro(phonestatus_say_enabled_disabled,record-status,${XIVO_CALLRECORD})
exten = s,n,GotoIf($["${XIVO_ENABLEDND}"=""]?$[${PRIORITY} + 2])
exten = s,n,Macro(phonestatus_say_enabled_disabled,dnd-status,${XIVO_ENABLEDND})
exten = s,n,Playback(bye)
exten = s,n,Hangup()

[macro-fwdundoall]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/fwdundoall)
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|unc|0|)
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|rna|0|)
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|busy|0|)
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(all-forward-off)
exten = s,n,Hangup()

[macro-fwdundounc]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,unc,0)
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|unc|0|)
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(forward-off)
exten = s,n,Hangup()

[macro-fwdunc]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,unc,1,${ARG1})
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|unc|1|${ARG1})
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(forward-on)
exten = s,n,Hangup()

[macro-fwdundorna]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,rna,0)
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|rna|0|)
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(forward-off)
exten = s,n,Hangup()

[macro-fwdrna]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,rna,1,${ARG1})
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|rna|1|${ARG1})
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(forward-on)
exten = s,n,Hangup()

[macro-fwdundobusy]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,busy,0)
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|busy|0|)
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(forward-off)
exten = s,n,Hangup()

[macro-fwdbusy]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,busy,1,${ARG1})
exten = s,n,Set(DEVSTATE(Custom:user${XIVO_USERID}_busy)=INUSE)
exten = s,n,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|busy|1|${ARG1})
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(forward-on)
exten = s,n,Hangup()

[macro-enablevm]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,vm)
exten = s,n,Macro(pickup,0)
exten = s,n,GotoIf(${XIVO_VMENABLED}?vmenabled,1:vmdisabled,1)

exten = novmbox,1,Hangup()

exten = vmenabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|vm|1|)
exten = vmenabled,n,Playback(vm-on)
exten = vmenabled,n,Hangup()

exten = vmdisabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|vm|0|)
exten = vmdisabled,n,Playback(vm-off)
exten = vmdisabled,n,Hangup()

[macro-enablednd]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,dnd)
exten = s,n,Macro(pickup,0)
exten = s,n,GotoIf(${XIVO_DNDENABLED}?dndenabled,1:dnddisabled,1)

exten = dndenabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|dnd|1|)
exten = dndenabled,n,Playback(dnd-on)
exten = dndenabled,n,Hangup()

exten = dnddisabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|dnd|0|)
exten = dnddisabled,n,Playback(dnd-off)
exten = dnddisabled,n,Hangup()

[macro-incallrec]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,callrecord)
exten = s,n,Macro(pickup,0)
exten = s,n,GotoIf(${XIVO_CALLRECORDENABLED}?callrecordenabled,1:callrecorddisabled,1)

exten = callrecordenabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|callrecord|1|)
exten = callrecordenabled,n,Playback(record-call-on)
exten = callrecordenabled,n,Hangup()

exten = callrecorddisabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|callrecord|0|)
exten = callrecorddisabled,n,Playback(record-call-off)
exten = callrecorddisabled,n,Hangup()

[macro-incallfilter]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,callfilter)
exten = s,n,Macro(pickup,0)
exten = s,n,GotoIf(${XIVO_CALLFILTERENABLED}?callfilterenabled,1:callfilterdisabled,1)

exten = callfilterenabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|callfilter|1|)
exten = callfilterenabled,n,Playback(screening-on)
exten = callfilterenabled,n,Hangup()

exten = callfilterdisabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|callfilter|0|)
exten = callfilterdisabled,n,Playback(screening-off)
exten = callfilterdisabled,n,Hangup()

[macro-agentstaticlogin]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/agent_get_options,${ARG1})
exten = s,n,Macro(pickup,0)
exten = s,n,AgentCallBackLogin(${ARG1}|${XIVO_AGENTOPTIONS}|${XIVO_SRCNUM}@${XIVO_CONTEXT})
exten = s,n,Hangup()

[macro-agentstaticlogoff]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,Set(LANGUAGE()=${ARG2})
exten = s,n,AGI(agi://127.0.0.1/agent_get_options,${ARG1})
exten = s,n,System(/usr/sbin/asterisk -rx "agent logoff Agent/${ARG1}")
exten = s,n,Set(XIVO_SILENT=${FILTER(s,${XIVO_AGENTOPTIONS})})
exten = s,n,GotoIf(${XIVO_SILENT}?hangup)
exten = s,n,Macro(pickup,0)
exten = s,n,Playback(agent-loggedoff)
exten = s,n(hangup),Hangup()

[macro-agentdynamiclogin]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/agent_get_options,${ARG1})
exten = s,n,Macro(pickup,0)
exten = s,n,AgentLogin(${ARG1}|${XIVO_AGENTOPTIONS})
exten = s,n,Hangup()

[macro-calllistening]
exten = s,1,Macro(pickup,0)
exten = s,n,Authenticate(916735)
exten = s,n,ChanSpy()
exten = s,n,Hangup()

[macro-vmdelete]
exten = s,1,AGI(agi://127.0.0.1/user_get_vmbox)
exten = s,n,Macro(pickup,0)
exten = s,n,VMauthenticate(${XIVO_MAILBOX}@${XIVO_MAILBOX_CONTEXT})
exten = s,n,System(/bin/rm -f ${ARG1}/${XIVO_MAILBOX_CONTEXT}/${XIVO_MAILBOX}/*/* || /bin/true)
exten = s,n,PlayBack(vm-deleted)
exten = s,n,Hangup()

[macro-voicemsg]
exten = s,1,AGI(agi://127.0.0.1/user_get_vmbox)
exten = s,n,Macro(pickup,0)
exten = s,n,VoiceMailMain(${XIVO_MAILBOX}@${XIVO_MAILBOX_CONTEXT},${XIVO_VMOPTIONS})
exten = s,n,Hangup()

[macro-handynumbers]
exten = s,n,Set(XIVO_EXTENPATTERN=${ARG1})
exten = s,n,AGI(agi://127.0.0.1/handynumbers)
exten = s,n,GotoIf(${XIVO_INTERFACE}?:error,1)
exten = s,n,Dial(${XIVO_INTERFACE}/${XIVO_TRUNKEXTEN})

exten = error,1,NoOp(Unable to fetch user features, this is a bug)
exten = error,n,Hangup

; TODO: rewrite.
[macro-bsfilter]
exten = s,1,Set(XIVO_SRCNUM=${CALLERID(num)})
exten = s,n,Set(XIVO_DSTNUM=${MACRO_EXTEN})
exten = s,n,Set(XIVO_CONTEXT=${MACRO_CONTEXT})
exten = s,n,AGI(agi://127.0.0.1/user_set_feature,bsfilter,${ARG1})
exten = s,n,Macro(pickup,0)
exten = s,n,GotoIf(${XIVO_BSFILTERENABLED}?bsfilterenabled,1:bsfilterdisabled,1)

exten = bsfilterenabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|bsfilter|1|)
exten = bsfilterenabled,n,Devstate(${XIVO_DSTNUM},2)
exten = bsfilterenabled,n,Playback(screening-on)
exten = bsfilterenabled,n,Hangup()

exten = bsfilterdisabled,1,UserEvent(Feature,AppData: ${XIVO_CONTEXT}|${XIVO_SRCNUM}|bsfilter|0|)
exten = bsfilterdisabled,n,Devstate(${XIVO_DSTNUM},1)
exten = bsfilterdisabled,n,Playback(screening-off)
exten = bsfilterdisabled,n,Hangup()
