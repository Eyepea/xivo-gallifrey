; $Revision$
; $Date$

[macro-incomingcallbooster]
exten = s,1,NoOp(dialing ${REAL_DSTNUM:-4} from ${CHANNEL})
exten = s,n(next),AGI(xivo_push_callbooster|${REAL_DSTNUM:-4})
exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "intro"]?intro)

; one should get there only once in the loop
exten = s,n,GotoIf(${CB_FIRST}?firstiter-end)
exten = s,n,Set(CB_FIRST="already")

exten = s,n,GotoIf($["${CB_AGI_RECORD}" = ""]?record-end)
exten = s,n,MixMonitor(${CB_AGI_RECORD}.wav)
exten = s,n(record-end),NoOp()

exten = s,n,GotoIf($["${CB_AGI_MES_WAITINGMUSIC}" = ""]?setmoh-end)
exten = s,n,SetMusicOnHold(${CB_AGI_MES_WAITINGMUSIC})
exten = s,n(setmoh-end),NoOp()

exten = s,n(firstiter-end),NoOp()

exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "exit"]?exit)
exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "rep"]?rep)
exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "mes"]?mes)
exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "tel"]?tel)
exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "bas"]?tel)
exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "fic"]?tel)

exten = s,n(queue),NoOp(this is the queue call)
exten = s,n,Macro(callbooster-accueil)
exten = s,n,GotoIf($["${CB_AGI_STATUS}" = "noqueue"]?next)
exten = s,n,Queue(${CB_AGI_QUEUE_NAME},tT,,,${CB_AGI_QUEUE_WAIT})
; one should get there only if nobody has answered
exten = s,n,NoOp(statut de la queue = ${QUEUESTATUS})
exten = s,n,Goto(next)

exten = s,n(intro),NoOp(this is the intro message, when forced)
exten = s,n,Macro(callbooster-accueil)
exten = s,n,Goto(next)

exten = s,n(mes),NoOp(this is voicemail)
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_MES})
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M025})
exten = s,n,UserEvent(VoiceMailCB|AppData: ${CB_AGI_MES_INDEX}-${CB_AGI_MES_SDA})
exten = s,n,VoiceMail(${CB_AGI_MES_SDA}@default,s)
exten = s,n,Hangup()

exten = s,n(rep),NoOp(this is rep mode)
exten = s,n,Playback(${CB_AGI_ARG})
exten = s,n,Hangup()

exten = s,n(tel),NoOp(this is a phone call ${CB_AGI_TEL_PATIENTE} ${CB_AGI_TEL_CHERCHE})
exten = s,n,Set(CB_P=$[${CB_AGI_TEL_PATIENTE} + 1])
exten = s,n(loopP),NoOp(CB_P is ${CB_P})
exten = s,n,Set(CB_C=$[${CB_AGI_TEL_CHERCHE} + 1])
exten = s,n(loopC),NoOp(CB_C is ${CB_C})
exten = s,n,Dial(Local/${CB_AGI_TEL_NUM}@default,${CB_AGI_TEL_DELAY})
exten = s,n,Set(CB_C=$[${CB_C} - 1])
exten = s,n,GotoIf(${CB_C} > 0?:endLoopC)
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M007})
exten = s,n,Goto(loopC)
exten = s,n(endLoopC),NoOp(fin loop C)
exten = s,n,Set(CB_P=$[${CB_P} - 1])
exten = s,n,GotoIf(${CB_P} > 0?:endLoopP)
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M008})
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M009})
exten = s,n,Goto(loopP)

exten = s,n(endLoopP),NoOp(fin loop P)


exten = s,n,NoOp(the status is : ${STATUS} : ${DIALSTATUS} going back to AGI ...)
exten = s,n,Goto(next)

exten = s,n(exit),NoOp(this is the end)
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M005})
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M006})
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M012})
exten = s,n,Hangup()

[macro-callbooster-accueil]
exten = s,1,GotoIf(${CB_FIRST_WELCOME}?firstiterwelcome-end)
exten = s,n,Set(CB_FIRST_WELCOME="already")
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_WELCOME})
exten = s,n,Macro(callbooster-playback,${CB_AGI_MES_M002})
exten = s,n(firstiterwelcome-end),NoOp()

[macro-callbooster-playback]
exten = s,1,GotoIf($["${ARG1}" = ""]?callbooster-playback-end)
exten = s,n,Playback(${ARG1})
exten = s,n(callbooster-playback-end),NoOp(end ${ARG1})


[ctx-callbooster-alert]
exten = s,1,NoOp(message=${CB_ALERT_MESSAGE},repeat=${CB_ALERT_REPEAT},allowed=${CB_ALERT_ALLOWED},id=${CB_ALERT_ID})
exten = s,n(repeat),Playback(${CB_ALERT_MESSAGE})
exten = s,n(reread),Read(CB_DTMF,,1)
exten = s,n,AGI(agi_fb_svi)
exten = s,n,NoOp(agi return is ${CB_SVI_ACTION})
exten = s,n,GotoIf($["${CB_SVI_ACTION}" = "repeat"]?repeat)
exten = s,n,GotoIf($["${CB_SVI_ACTION}" = "reread"]?reread)
exten = s,n,UserEvent(AlertCB|AppData: ${CB_DTMF}-${CB_ALERT_ID})
exten = s,n,Hangup()

[ctx-callbooster-record]
exten = s,1,NoOp(record ${CB_RECORD_FILENAME})
exten = s,n,Record(${CB_RECORD_FILENAME}.wav)
exten = s,n,Hangup()


; replacement for Park() in order to set the MOH (esp. for outgoing calls)
[parkedcalls]
exten = 700,1,GotoIf($["${CB_MOH}" = ""]?norewritemoh)
exten = 700,n,SetMusicOnHold(${CB_MOH})
exten = 700,n(norewritemoh),Park()
