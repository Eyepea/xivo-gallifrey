# Xivo 0.3 - Build Asterisk.
# Copyright (C) 2006 Richard Braun <rbraun@proformatique.com>
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

ASTERISK_SOURCE="asterisk-1.2.13.tar.gz"
ASTERISK_URL="http://ftp.digium.com/pub/asterisk/releases/$ASTERISK_SOURCE"
ASTERISK_SIZE="10584113"
ASTERISK_SHA1SUM="d2ec77e08f512a3fa11fd8639a7fe629a46ed242"

ASTERISK_UCLIBC_PATCH="asterisk-1.2.10_uclibc.patch"
ASTERISK_CAP_PATCH="asterisk-1.2.5-cap.diff"
ASTERISK_DEPS_PATCH="asterisk-1.2.10_deps.patch"

# Set $AST_ARCH from $ARCH.
# 
# usage: asterisk_set_arch
asterisk_set_arch()
{
  # TODO: create sub-architectures.
  if [ "$ARCH" = "powerpc" ] || [ "$ARCH" = "ppc_rgwypq2" ]; then
    AST_ARCH=ppc
  else
    AST_ARCH=$ARCH
  fi
}

# usage: asterisk_build
asterisk_build()
{
  if [ "$USE_UCLIBC" ]; then
    apply_patch $ASTERISK_UCLIBC_PATCH
  fi

  apply_patch $ASTERISK_CAP_PATCH
  apply_patch $ASTERISK_DEPS_PATCH

  # I suspect the build process to uncorrectly support parallel builds.
  asterisk_set_arch
  do_make CROSS_COMPILE=$TOOLCHAIN/bin/$TARGET- \
          CROSS_COMPILE_BIN=$TOOLCHAIN/bin \
          CROSS_COMPILE_TARGET=$SYSROOT \
          CROSS_ARCH=Linux \
          CROSS_PROC=$AST_ARCH \
          DESTDIR=$SYSROOT \
          -j 1
}

# usage: asterisk_install
asterisk_install()
{
  mkdir -p -m 755 $SYSROOT/usr/lib/asterisk/modules
  asterisk_set_arch
  do_make CROSS_COMPILE=$TOOLCHAIN/bin/$TARGET- \
          CROSS_COMPILE_BIN=$TOOLCHAIN/bin \
          CROSS_COMPILE_TARGET=$SYSROOT \
          CROSS_ARCH=Linux \
          CROSS_PROC=$AST_ARCH \
          DESTDIR=$SYSROOT \
          install -j 1

  # Asterisk may register itself at the local GnuGk, so start it lately.
  install_rc_script $SYSCONFDIR/asterisk/asterisk 25
  rm -rf $SYSROOT/etc/asterisk
  mkdir -p -m 755 $SYSCONF/etc/asterisk
  ln -s /mnt/etc/asterisk $SYSROOT/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/agents.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/asterisk.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/extensions.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/features.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/iax.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/iaxprov.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/logger.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/manager.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/modules.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/queues.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/sip.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/voicemail.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/meetme.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/asterisk/musiconhold.conf $SYSCONF/etc/asterisk
  install -m 644 $SYSCONFDIR/zaptel/zapata.conf $SYSCONF/etc/asterisk
  install -m 755 $SYSCONFDIR/asterisk/callback $SYSROOT/usr/sbin

  # If /var exists in $SYSROOT, it'll be entirely moved to $SYSCONF.
  # See include/sysconf.
  mkdir -p -m 755 $SYSROOT/var/spool/cron/crontabs
  install -m 600 $SYSCONFDIR/asterisk/crontab $SYSROOT/var/spool/cron/crontabs/asterisk
  mkdir -p -m 755 $SYSROOT/var/spool/asterisk/pre-outgoing
  mkdir -p -m 755 $SYSROOT/var/spool/asterisk/queue-outgoing
  mkdir -p -m 755 $SYSROOT/var/lib/asterisk/moh
  install -m 644 $DATADIR/fpm-calm-river.gsm $SYSROOT/var/lib/asterisk/moh
  install -m 644 $DATADIR/fpm-sunshine.gsm $SYSROOT/var/lib/asterisk/moh
  install -m 644 $DATADIR/fpm-world-mix.gsm $SYSROOT/var/lib/asterisk/moh
  install -m 644 $DATADIR/xivo-attendant.gsm $SYSROOT/var/lib/asterisk/sounds
}

# usage: make_asterisk
make_asterisk()
{
  make_ncurses
  make_openssl
  make_zaptel
  make_libpri

  get_basename $ASTERISK_SOURCE
  make_package $ASTERISK_SOURCE $ASTERISK_URL $ASTERISK_SIZE $ASTERISK_SHA1SUM \
               $BASENAME asterisk_build asterisk_install
}
