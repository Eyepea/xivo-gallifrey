# Xivo 0.3 - Build PHP.
# Copyright (C) 2006 Richard Braun <rbraun@proformatique.com>
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

PHP_SOURCE="php-4.4.4.tar.bz2"
PHP_URL="http://fr.php.net/distributions/$PHP_SOURCE"
PHP_SIZE="4478698"
PHP_SHA1SUM="05d62910fb5734344db87f0a17b1e8e001b26b05"

PHP_UCLIBC_CROSSCOMPILE_PATCH="php-4.4.2_uclibc_crosscompile.patch"

# usage: php_build
php_build()
{
  apply_patch $PHP_UCLIBC_CROSSCOMPILE_PATCH

  if [ "$BIG_ENDIAN" = "true" ]; then
    big_endian=yes
  else
    big_endian=no
  fi

  # Ugly hacks - see the patch applied above.
  EXTRA_LIBS="-ldl" \
  enable_dlopen=yes \
  ac_cv_func_dlopen=yes \
  ac_cv_lib_dl_dlopen=yes \
  ac_cv_func_getaddrinfo=yes \
  ac_cv_sizeof_intmax_t=$SIZEOF_INTMAX_T \
  ac_cv_sizeof_size_t=$SIZEOF_SIZE_T \
  ac_cv_sizeof_ssize_t=$SIZEOF_SSIZE_T \
  ac_cv_sizeof_ptrdiff_t=$SIZEOF_PTRDIFF_T \
  ac_cv_sizeof_long_long=$SIZEOF_LONG_LONG \
  ac_cv_sizeof_long_long_int=$SIZEOF_LONG_LONG \
  ac_cv_sizeof_long=$SIZEOF_LONG \
  ac_cv_sizeof_int=$SIZEOF_INT \
  ac_cv_sizeof_char=$SIZEOF_CHAR \
  ac_cv_c_bigendian_php=$big_endian \
  ./configure --build=$BUILD \
              --host=$TARGET \
              --prefix=$SYSROOT/usr \
              --enable-discard-path \
              --with-layout=GNU \
              --with-config-file-path=/etc \
              --with-exec-dir=/usr/lib/php/libexec \
              --disable-rpath \
              --with-openssl \
              --with-mime-magic \
              --with-zlib \
              --with-bz2 \
              --with-gd \
              --with-png-dir=$SYSROOT/usr \
              --with-jpeg-dir=$SYSROOT/usr \
              --enable-gd-native-ttf \
              --enable-ftp \
              --enable-socket \
              --enable-calendar \
              --enable-shmop \
              --enable-bcmath \
              --enable-sysvmsg \
              --enable-sysvsem \
              --enable-sysvshm \
              --enable-memory-limit \
              --disable-static \
              --enable-shared \
              --with-pic \
              --without-mysql \
              --without-pgsql \
              --without-pear
  do_make
}

# usage: php_install
php_install()
{
  do_make install
  make_conf_file php/php.ini /etc 644
  mkdir -p -m 755 $SYSROOT/usr/share/misc
  install -m 644 $SYSCONFDIR/php/magic.mime $SYSROOT/usr/share/misc
}

# usage: make_php
make_php()
{
  make_openssl
  make_zlib
  make_libbz2
  make_libpng
  make_libjpeg

  get_basename $PHP_SOURCE
  use_extended_path
  make_package $PHP_SOURCE $PHP_URL $PHP_SIZE $PHP_SHA1SUM \
               $BASENAME php_build php_install
  use_simple_path
}
