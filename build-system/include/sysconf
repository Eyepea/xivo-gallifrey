# Xivo 0.3 - Handle system configuration files.
# Copyright (C) 2006 Richard Braun <rbraun@proformatique.com>
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

# Install RC scripts.
# 
# usage: make_rc_scripts
make_rc_scripts()
{
  install_rc_script $SYSCONFDIR/rcS 00 00
  install_rc_script $SYSCONFDIR/shutdown 00 00
  install_rc_script $SYSCONFDIR/mountsys 01 99
  install_rc_script $SYSCONFDIR/filldev 02 00
  install_rc_script $SYSCONFDIR/loadmodules 03 00
  install_rc_script $SYSCONFDIR/hwclock 04 98
  install_rc_script $SYSCONFDIR/mountfstab 05 97
  install_rc_script $SYSCONFDIR/hostname 06 00

  # Don't call /etc/init.d/networking at shutdown so that network is up when
  # processes are killed. SSH processes getting killed will close
  # connections automatically.
  install_rc_script $SYSCONFDIR/networking 10 00

  install_rc_script $SYSCONFDIR/upgrade_firmware 00 00
  install_rc_script $SYSCONFDIR/reset_factory_defaults 00 00
}

# Create the dist file.
# 
# usage: make_distfile
make_distfile()
{
  distfile="$SYSROOT/etc/dist"
  echo "DIST_NAME=\"Xivo\"" > $distfile
  echo "DIST_VERSION=\"$DIST_VERSION\"" >> $distfile
  chmod 644 $distfile
}

# Create fstab.
# 
# usage: make_fstab
make_fstab()
{
  gen_fstab > $SYSROOT/etc/fstab
  chmod 644 $SYSROOT/etc/fstab
}

# Create /etc/hostname as a symbolic link to /mnt/hostname.
# Also create /etc/hosts.
# 
# usage: make_hostname
make_hostname()
{
  echo $DIST_HOSTNAME > $SYSCONF/hostname
  ln -s /mnt/hostname $SYSROOT/etc/hostname

  # TODO: There should be a unique source for the IP address.
  echo "127.0.0.1 localhost.localdomain localhost" > $SYSCONF/hosts
  echo "192.168.0.221 $DIST_HOSTNAME" >> $SYSCONF/hosts
  ln -s /mnt/hosts $SYSROOT/etc/hosts
}

# Handle passwd/group/shadow/gshadow files (tricky when /etc is readonly).
# See the sysconf/chpass wrapper (which is installed as /usr/sbin/passwd).
# 
# usage: make_passwd
make_passwd()
{
  # These files are copied by /etc/init.d/filldev in a temporary /mnt tmpfs
  # file system so that mdev.conf can use names instead of UIDs/GIDs (the
  # real /mnt file system cannot be mounted at that step of the boot process).
  install -m 644 $SYSCONFDIR/passwd $SYSROOT/etc/.passwd.mdev
  install -m 644 $SYSCONFDIR/group $SYSROOT/etc/.group.mdev

  make_conf_file passwd /etc 644
  make_conf_file shadow /etc 600
  make_conf_file group /etc 644
  make_conf_file gshadow /etc 600

  for file in passwd group shadow gshadow; do
    install -m 600 $SYSCONF/$file $SYSCONF/$file-
    ln -s /mnt/$file- $SYSROOT/etc/$file-
  done

  install -m 4755 $SYSCONFDIR/chpass $SYSROOT/usr/sbin/passwd
}

# Create /etc/modules.
# 
# make_modules
make_modules()
{
  install -m 644 $SYSCONFDIR/modules $SYSROOT/etc
  gen_modules >> $SYSROOT/etc/modules
}

# Create /etc/network tree.
# 
# usage: make_network
make_network()
{
  make_conf_file interfaces /etc/network 644
  mkdir $SYSROOT/etc/network/if-{pre-up,up,down,post-down}.d
  make_conf_file resolv.conf /etc 644
  install -m 644 $SYSCONFDIR/services $SYSROOT/etc
  install -m 644 $SYSCONFDIR/protocols $SYSROOT/etc
}

# Create the /var tree. This should be done very late in the process, to
# avoid adding files to /var after this function has been called.
# 
# usage: make_var
make_var()
{
  if [ -d $SYSROOT/var ]; then
    mv $SYSROOT/var $SYSCONF
  fi

  mkdir -p -m 755 $SYSCONF/var/{lib,log,run,spool,tmp,www}
  chmod 1777 $SYSCONF/var/tmp
  ln -s /mnt/var $SYSROOT/var
  touch $SYSCONF/var/log/lastlog
  chmod 644 $SYSCONF/var/log/lastlog
  touch $SYSCONF/var/log/wtmp
  chmod 644 $SYSCONF/var/log/wtmp
}

make_inittab()
{
  install -m 644 $SYSCONFDIR/inittab $SYSROOT/etc
  echo "::respawn:/sbin/getty -L $DIST_CONSOLE $DIST_CONSOLE_SPEED vt100" >> \
  $SYSROOT/etc/inittab
}

# Create system configuration files.
# 
# usage: make_sysconf
make_sysconf()
{
  make_rc_scripts
  make_distfile
  make_fstab
  make_hostname
  make_passwd
  make_modules
  make_network
  make_var
  make_inittab
  install -m 644 $SYSCONFDIR/mdev.conf $SYSROOT/etc
  install -m 755 $SYSCONFDIR/hotplug $SYSROOT/sbin
  ln -s /proc/mounts $SYSROOT/etc/mtab
  install -m 644 $SYSCONFDIR/profile $SYSROOT/etc
  /sbin/depmod -b $SYSROOT -F $SYSBOOT/System.map -a $KERNEL_VERSION
}
