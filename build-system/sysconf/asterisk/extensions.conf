[macro-check_forward]
exten = s,1,Set(FORWARD=${DB(forward/${REAL_EXTEN})})
exten = s,n,Set(DEST=${IF($[${DB_EXISTS(forward/${REAL_EXTEN})} = 1]?${FORWARD}:${REAL_EXTEN})})

[macro-monitor]
exten = s,1,Set(DYNAMIC_FEATURES=automon)
exten = s,n,Set(TOUCH_MONITOR_FORMAT=gsm)

[macro-check_blacklist]
exten = s,1,GotoIf(${DB_EXISTS(blacklist/${CALLERID(num)})}?blacklisted:notblacklisted)
exten = s,n(blacklisted),Playback(privacy-incorrect)
exten = s,n,Hangup
exten = s,n(notblacklisted),NoOp

[macro-incoming-start]
exten = s,1,Set(REAL_EXTEN=${MACRO_EXTEN})
exten = s,n,Macro(check_forward)
exten = s,n,Macro(check_blacklist)
exten = s,n,Macro(monitor)

[macro-voicemail]
exten = s,1,Set(MAILBOX=${REAL_EXTEN})
exten = s,n,Voicemail(${MAILBOX})
exten = s,n,Hangup

; This is not optimal, as this implies many fork() calls.
; TODO: create a compiled program to do the work.
[macro-callback]
exten = s,1,Set(TMP=/var/tmp)
exten = s,n,Set(QUEUE=/var/spool/asterisk/queue-outgoing)
exten = s,n,Set(FILE=${TMP}/${TIMESTAMP}.call)
exten = s,n,Set(CHANTECH=${CUT(CHANNEL,/,1)})
exten = s,n,System(echo "Channel: ${CHANTECH}/${REAL_EXTEN}" > ${FILE})
exten = s,n,System(echo "MaxRetries: 2" >> ${FILE})
exten = s,n,System(echo "RetryTime: 20" >> ${FILE})
exten = s,n,System(echo "WaitTime: 20" >> ${FILE})
exten = s,n,System(echo "Context: from-asterisk" >> ${FILE})
exten = s,n,System(echo "Extension: ${CALLERID(num)}" >> ${FILE})
exten = s,n,System(echo "Priority: 1" >> ${FILE})
exten = s,n,System(chown asterisk:asterisk ${FILE})

; Make sure the temp file and its destination directory are on the same file
; system so that mv is atomic.
exten = s,n,System(mv ${FILE} ${QUEUE})
exten = s,n,Playback(privacy-thankyou)
exten = s,n,Hangup

[voicemail_callback]
exten = s,1,Background(vm-tomakecall&vm-leavemsg|m)
exten = 4,1,Macro(callback)
exten = 5,1,Macro(voicemail)

[macro-incoming-end]
exten = s,1,Set(REAL_EXTEN=${MACRO_EXTEN})
exten = s,n,Goto(s-${DIALSTATUS},1)

exten = s-NOANSWER,1,Goto(s-CHANUNAVAIL,1)
exten = s-ANSWER,1,Hangup
exten = s-CONGESTION,1,Goto(s-CHANUNAVAIL,1)
exten = s-CANCEL,1,Goto(s-CHANUNAVAIL,1)

exten = s-BUSY,1,Playback(vm-theperson)
exten = s-BUSY,n,SayNumber(${REAL_EXTEN})
exten = s-BUSY,n,Playback(vm-isonphone)
exten = s-BUSY,n,Goto(voicemail_callback,s,1)

exten = s-CHANUNAVAIL,1,Playback(vm-theperson)
exten = s-CHANUNAVAIL,n,SayNumber(${REAL_EXTEN})
exten = s-CHANUNAVAIL,n,Playback(vm-isunavail)
exten = s-CHANUNAVAIL,n,Goto(voicemail_callback,s,1)

[macro-away_forward_set]
exten = s,1,Answer
exten = s,n,Set(DB(forward/${CALLERIDNUM})=${MACRO_EXTEN:2})
exten = s,n,Playback(privacy-thankyou)
exten = s,n,Hangup

[macro-away_forward_unset]
exten = s,1,Answer
exten = s,n,DBdel(forward/${CALLERIDNUM})
exten = s,n,Playback(privacy-thankyou)
exten = s,n,Hangup

[macro-blacklist_add]
exten = s,1,Answer
exten = s,n,Set(DB(blacklist/${ARG1})=1)
exten = s,n,Playback(privacy-thankyou)
exten = s,n,Hangup

[macro-blacklist_del]
exten = s,1,Answer
exten = s,n,DBdel(blacklist/${ARG1})
exten = s,n,Playback(privacy-thankyou)
exten = s,n,Hangup

[features]
exten = 887,1,Queue(test)
exten = 887,n,Hangup

exten = 888,1,VoiceMailMain(${CALLERIDNUM},s)
exten = 888,n,Hangup

exten = 889,1,Directory(default)
exten = 889,n,Hangup

exten = _0XX,1,MeetMe(${EXTEN},1Mpq)
exten = _0XX,n,Hangup

exten = _*0.,1,Macro(away_forward_set)
exten = *0,1,Macro(away_forward_unset)

exten = _*2.,1,Macro(blacklist_add,${EXTEN:2})
exten = _*3.,1,Macro(blacklist_del,${EXTEN:2})

exten = _*4.,1,Pickup(${EXTEN:2})
exten = _*4.,n,Hangup

[exten-local]
include = features

exten = _30X,1,Macro(incoming-start)
exten = _30X,n,Dial(SIP/${DEST},30,w)
exten = _30X,n,Macro(incoming-end)

[exten-out]
; mISDN support needs more testing.
;exten = _XXXX.,1,Dial(mISDN/1/${EXTEN})
;exten = _XXXX.,n,Hangup

; Currently no Zaptel device available.
;exten = _XXXX.,1,Dial(Zap/4/${EXTEN})
;exten = _XXXX.,n,Hangup

[outgoing-callback]
include = exten-local
include = exten-out

exten = s,1,Answer
exten = s,n,Wait(2)
exten = s,n,Playback(queue-callswaiting)
exten = s,n,Goto(${REAL_EXTEN},1)
exten = s,n,Hangup

[from-asterisk]
include = exten-local
include = exten-out

[from-sip]
include = exten-local
include = exten-out

[default]
include = exten-local
include = exten-out
