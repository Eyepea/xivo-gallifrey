#! /usr/bin/python
# vim: set fileencoding=utf-8 :
#
# $Revision: 322 $
# $Date: 2007-04-11 13:57:07 +0200 (mer, 11 avr 2007) $
#
# Authors : Thomas Bernard, Corentin Le Gall
#           Proformatique
# script de push de fiche
#

import socket, sys, generefiche, ConfigParser, string

config = ConfigParser.ConfigParser()
try:
	config.readfp(open("/etc/asterisk/xivo_push.conf"))
	databasekind = config.get('general', 'db')
except:
	databasekind = ""

if databasekind == "ldap":
	import ldap
	LDAP_HOST = "192.168.0.247"
	LDAP_PORT = "389"
	LDAP_USER = "cn=admin,dc=lan,dc=proformatique,dc=com"
	LDAP_PASS  = "openxchange"
	LDAP_BASE = "dc=lan,dc=proformatique,dc=com"

	class myldap:
		def __init__(self):
			try:
				self.l = ldap.initialize("ldap://%s:%s" %(LDAP_HOST, LDAP_PORT))
				self.l.protocol_version = ldap.VERSION3
				self.l.simple_bind_s(LDAP_USER, LDAP_PASS)

			except ldap.LDAPError, e:
				print e
				sys.exit()

		def getldap(self, filter, attrib):
			try:
				resultat = self.l.search_s(LDAP_BASE, ldap.SCOPE_SUBTREE, filter, attrib)
				return resultat
			except ldap.LDAPError, e:
				print e

elif databasekind == "mysql":
	import MySQLdb
	con = MySQLdb.connect(host="127.0.0.1", port=3306, user="vip", passwd="vip", db="asterisk")
	cursor = con.cursor()


#print sys.argv[0], len(sys.argv)
if len(sys.argv) < 6:
	print "Usage :", sys.argv[0], "<server> <port> <proto> <user> <callerid> <msgext>"
	sys.exit(1)
else:
	shost = sys.argv[1]
	sport = int(sys.argv[2])
	proto = sys.argv[3]
	exten = sys.argv[4]
	callerid = sys.argv[5]
	user = proto + exten
	if len(sys.argv) > 6:
		msgext = sys.argv[6]
	else:
		msgext = ""




# first connect to the server to get ip, port of the client
z = generefiche.getuserlocation(shost, sport, user)
print z
if z == None:
	print "could not localize user", user
	sys.exit(3)
sessionid = z.get('sessionid')
clientaddress = z.get('address')

if databasekind == "ldap":
	result = myldap().getldap("(|(telephonenumber=%s)(mobile=%s)(pager=%s))" %(callerid,callerid,callerid),['cn','mail'])
elif databasekind == "mysql":
	sql = "select * from vip_tel where appelant REGEXP '" + callerid + "';"
	cursor.execute(sql)
	results = cursor.fetchall()
	con.close()
	x = results[0]

#####################################

name = ""
firstname = ""
mail = ""
url = ""
try:
	msg = config.get('msg', 'day')
except:
	msg = "un Jour un Message"

try:
	url = config.get('photo', callerid)
except:
	url = "file:///home/proformatique/Manque.png"

try:
	homepage = config.get('general', 'homepage')
except:
	homepage = "http://www.proformatique.com"

if databasekind == "ldap":
	try:
		r = result[0][1]['cn'][0]
		mail = result[0][1]['mail'][0]
		(name, firstname) = r.split()
		sys.stdout.write("SET CALLERID \"%s\"\n" %r)
	except:
		print "No callerid from OX"
elif databasekind == "mysql":
	try:
		mail = "notyetrelevant@here.fr"
## 298529812   06   520912   LE HENAFF LAURENT   29000   QUIMPER
		name = x[3]
		firstname = "not yet relevant"
		print "SET CALLERID \"" + name + "\""
	except:
		mail = "unknown@unkwown.fr"
		name = "humhum"
		firstname = "still not relevant"
		print "no found in mysql db"

if not name:
	name = "Inconnu"
if not firstname:
	firstname = "Inconnu"
if not mail:
	mail = "Inconnu"
if not callerid:
	callerid = "Inconnu"
if not url:
	url = "file:///home/proformatique/Manque.png"

z = generefiche.getuserlocation(shost, sport, user)
if z == None:
        print "could not localize user", user

sessionid = z.get('sessionid')
clientaddress = z.get('address')
clientstate = z.get('state')

if clientstate == "available":
	print "SET VARIABLE STATUS 0"

	fiche = generefiche.Fiche(sessionid)
	fiche.setmessage(msgext)
	fiche.addinfo('Nom', 'text', name)
	fiche.addinfo('Prenom', 'text', firstname)
	fiche.addinfo('Numero', 'phone', callerid)
	fiche.addinfo('Photo', 'picture', url)
	fiche.addinfo('Adresse email', 'url', 'mailto:' + mail)
	fiche.addinfo('Homepage', 'url', homepage)
	fiche.addinfo('Message du jour', 'text', '<b>' + msg + '</b>')

	#connect to the client and send the stuff !
	if fiche.sendtouser(clientaddress):
		print "Profile sent"
	else:
		print "could not send profile to user"

elif clientstate == "away":
	print "SET VARIABLE STATUS 1"
	print "away"

elif clientstate == "doesnotdisturb":
	print "SET VARIABLE STATUS 2"
	print "doesnotdisturb"


sys.stdout.flush()
sys.stderr.flush()

