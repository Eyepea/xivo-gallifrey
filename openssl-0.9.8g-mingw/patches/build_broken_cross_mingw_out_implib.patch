Index: openssl-0.9.8g/Makefile.shared
===================================================================
--- openssl-0.9.8g.orig/Makefile.shared	2007-09-16 16:11:51.000000000 +0200
+++ openssl-0.9.8g/Makefile.shared	2008-01-02 15:02:18.000000000 +0100
@@ -42,6 +42,9 @@
 # names of all object files that go into the target library.
 LIBEXTRAS=
 
+# ONLY FOR A SPECIFIC PATCH FOR CYGWIN/MINGW:
+LIBINTEXTRAS=$(LIBEXTRAS) lib$(LIBNAME).def
+
 # LIBVERSION contains the current version of the library.
 # For example, to build libfoo.so.1.2, you need to do the following:
 #LIBVERSION=1.2
@@ -102,6 +105,7 @@
     SHAREDCMD="$${SHAREDCMD:-$(CC)}"; \
     SHAREDFLAGS="$${SHAREDFLAGS:-$(CFLAGS) $(SHARED_LDFLAGS)}"; \
     nm -Pg $$SHOBJECTS | grep ' [BDT] ' | cut -f1 -d' ' > lib$(LIBNAME).exp; \
+    $(PERL) $(TOP)/util/create_def.pl $$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX $$BASE_ADDR < lib$(LIBNAME).exp > lib$(LIBNAME).def; \
     LIBPATH=`for x in $$LIBDEPS; do if echo $$x | grep '^ *-L' > /dev/null 2>&1; then echo $$x | sed -e 's/^ *-L//'; fi; done | uniq`; \
     LIBPATH=`echo $$LIBPATH | sed -e 's/ /:/g'`; \
     LD_LIBRARY_PATH=$$LIBPATH:$$LD_LIBRARY_PATH \
@@ -109,7 +113,7 @@
 	-o $$SHLIB$$SHLIB_SOVER$$SHLIB_SUFFIX \
 	$$ALLSYMSFLAGS $$SHOBJECTS $$NOALLSYMSFLAGS $$LIBDEPS \
   ) && $(SYMLINK_SO); \
-  ( $(SET_X); rm -f lib$(LIBNAME).exp )
+  ( $(SET_X); rm -f lib$(LIBNAME).exp lib$(LIBNAME).def )
 
 SYMLINK_SO=	\
 	if [ -n "$$INHIBIT_SYMLINKS" ]; then :; else \
@@ -127,8 +131,8 @@
 		fi; \
 	fi
 
-LINK_SO_A=	SHOBJECTS="lib$(LIBNAME).a $(LIBEXTRAS)"; $(LINK_SO)
-LINK_SO_O=	SHOBJECTS="$(LIBEXTRAS)"; $(LINK_SO)
+LINK_SO_A=	SHOBJECTS="lib$(LIBNAME).a $(LIBINTEXTRAS)"; $(LINK_SO)
+LINK_SO_O=	SHOBJECTS="$(LIBINTEXTRAS)"; $(LINK_SO)
 
 LINK_SO_A_VIA_O=	\
   SHOBJECTS=lib$(LIBNAME).o; \
@@ -248,13 +252,17 @@
 	SHAREDFLAGS="$(CFLAGS) $(SHARED_LDFLAGS) -shared $$base -Wl,-Bsymbolic -Wl,--out-implib,lib$(LIBNAME).dll.a"; \
 	$(LINK_SO_O)
 link_a.cygwin:
-	@ $(CALC_VERSIONS); \
+	@ $(SET_X); $(CALC_VERSIONS); \
 	INHIBIT_SYMLINKS=yes; \
 	SHLIB=cyg$(LIBNAME); \
 	base=-Wl,--enable-auto-image-base; \
 	if expr $(PLATFORM) : 'mingw' > /dev/null; then \
 		SHLIB=$(LIBNAME)eay32; \
-		base=;  [ $(LIBNAME) = "crypto" ] && base=-Wl,--image-base,0x63000000; \
+		base=; \
+		if [ $(LIBNAME) = "crypto" ] ; then \
+			base=-Wl,--image-base,0x63000000; \
+			BASE_ADDR=0x63000000; \
+		fi; \
 	fi; \
 	SHLIB_SUFFIX=.dll; \
 	SHLIB_SOVER=-$(LIBVERSION); \
Index: openssl-0.9.8g/util/create_def.pl
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ openssl-0.9.8g/util/create_def.pl	2008-01-02 14:26:50.000000000 +0100
@@ -0,0 +1,49 @@
+#!/usr/bin/perl
+
+if (@ARGV < 1) {
+	print STDERR "syntax: $0 <dll_filename> [<base_addr>] < library.exp > library.def\n";
+	print STDERR "\n";
+	print STDERR "This program generates a definition file suitable for the creation of a DLL\n";
+	print STDERR "library by Cygwin/MinGW. This definition file mainly contains the list of\n";
+	print STDERR "symbols that must be exported by the DLL.\n";
+	print STDERR "\n";
+	print STDERR "<dll_filename> is the wanted name for the DLL that will be created later, by\n";
+	print STDERR "including the name of the file generated by this program in the parameters of\n";
+	print STDERR "GCC (or possibly directly ld?)\n";
+	print STDERR "\n";
+	print STDERR "<base_addr> is the wanted base address for the target DLL.\n";
+	print STDERR "This is an optional parameter. If omitted the default base is determined by the\n";
+	print STDERR "linker.\n";
+	print STDERR "\n";
+	print STDERR "If <dll_filename> is to be created from an archive from which all extern\n";
+	print STDERR "symbols are to be exported by the DLL, library.exp typically can be generated\n";
+	print STDERR "by:\n";
+	print STDERR "\tnm -Pg libfoobar.a | grep ' [BDT] ' | cut -f1 -d' ' > libfoobar.exp\n";
+	print STDERR "where libfoobar.a is the archive of objects that will be used to create the DLL.\n";
+	print STDERR "\n";
+	print STDERR "Because we only target Windows systems and the stdin must have the same format\n";
+	print STDERR "as it has when generated by the above nm+grep+cut PIPE, symbols from stdin must\n";
+	print STDERR "be prepended by a single '_' character, there must be one symbol per line and\n";
+	print STDERR "nothing else. Symbols containing the '\@' character are considered special and\n";
+	print STDERR "silently ignored.\n";
+	exit 1;
+}
+
+$library_name = $ARGV[0];
+if (@ARGV > 1) {
+	$base_addr = $ARGV[1];
+	$base_parm = " BASE=$base_addr";
+}
+
+while(<STDIN>) {
+	if (/^_([^@]+)\r?\n$/) {
+		$symbols[@symbols] = $1;
+	}
+}
+@symbols = sort @symbols;
+
+print "LIBRARY \"$library_name\"$base_parm\r\n";
+print "EXPORTS\r\n";
+foreach (@symbols) {
+	print "\t$_\r\n";
+}
Index: openssl-0.9.8g/Makefile
===================================================================
--- openssl-0.9.8g.orig/Makefile	2008-01-02 14:50:57.000000000 +0100
+++ openssl-0.9.8g/Makefile	2008-01-02 15:04:07.000000000 +0100
@@ -281,6 +281,7 @@
 		$(MAKE) -f $(HERE)/Makefile.shared -e $(BUILDENV) \
 			LIBNAME=$$i LIBVERSION=${SHLIB_MAJOR}.${SHLIB_MINOR} \
 			LIBCOMPATVERSIONS=";${SHLIB_VERSION_HISTORY}" \
+			TOP="$(HERE)" \
 			symlink.$(SHLIB_TARGET); \
 		libs="$$libs -l$$i"; \
 	done
@@ -296,6 +297,7 @@
 			LIBNAME=$$i LIBVERSION=${SHLIB_MAJOR}.${SHLIB_MINOR} \
 			LIBCOMPATVERSIONS=";${SHLIB_VERSION_HISTORY}" \
 			LIBDEPS="$$libs $(EX_LIBS)" \
+			TOP="$(HERE)" \
 			link_a.$(SHLIB_TARGET); \
 		libs="-l$$i $$libs"; \
 	done
Index: openssl-0.9.8g/Makefile.org
===================================================================
--- openssl-0.9.8g.orig/Makefile.org	2008-01-02 14:50:57.000000000 +0100
+++ openssl-0.9.8g/Makefile.org	2008-01-02 15:04:15.000000000 +0100
@@ -279,6 +279,7 @@
 		$(MAKE) -f $(HERE)/Makefile.shared -e $(BUILDENV) \
 			LIBNAME=$$i LIBVERSION=${SHLIB_MAJOR}.${SHLIB_MINOR} \
 			LIBCOMPATVERSIONS=";${SHLIB_VERSION_HISTORY}" \
+			TOP="$(HERE)" \
 			symlink.$(SHLIB_TARGET); \
 		libs="$$libs -l$$i"; \
 	done
@@ -294,6 +295,7 @@
 			LIBNAME=$$i LIBVERSION=${SHLIB_MAJOR}.${SHLIB_MINOR} \
 			LIBCOMPATVERSIONS=";${SHLIB_VERSION_HISTORY}" \
 			LIBDEPS="$$libs $(EX_LIBS)" \
+			TOP="$(HERE)" \
 			link_a.$(SHLIB_TARGET); \
 		libs="-l$$i $$libs"; \
 	done
Index: openssl-0.9.8g/apps/Makefile
===================================================================
--- openssl-0.9.8g.orig/apps/Makefile	2008-01-02 14:44:37.000000000 +0100
+++ openssl-0.9.8g/apps/Makefile	2008-01-02 15:02:18.000000000 +0100
@@ -89,6 +89,7 @@
 	$(MAKE) -f $(TOP)/Makefile.shared -e \
 		APPNAME=req OBJECTS="sreq.o $(A_OBJ) $(RAND_OBJ)" \
 		LIBDEPS="$(PEX_LIBS) $(LIBCRYPTO) $(EX_LIBS)" \
+		TOP="$(TOP)" \
 		link_app.$${shlib_target}
 
 sreq.o: req.c 
@@ -157,6 +158,7 @@
 	$(MAKE) -f $(TOP)/Makefile.shared -e \
 		APPNAME=$(EXE) OBJECTS="$(PROGRAM).o $(E_OBJ)" \
 		LIBDEPS="$(PEX_LIBS) $$LIBRARIES $(EX_LIBS)" \
+		TOP="$(TOP)" \
 		link_app.$${shlib_target}
 	-(cd ..; \
 	  OPENSSL="`pwd`/util/opensslwrap.sh"; export OPENSSL; \
Index: openssl-0.9.8g/engines/Makefile
===================================================================
--- openssl-0.9.8g.orig/engines/Makefile	2008-01-02 14:52:38.000000000 +0100
+++ openssl-0.9.8g/engines/Makefile	2008-01-02 15:02:18.000000000 +0100
@@ -68,6 +68,7 @@
 			$(MAKE) -f ../Makefile.shared -e \
 				LIBNAME=$$l LIBEXTRAS=e_$$l.o \
 				LIBDEPS='-L.. -lcrypto $(EX_LIBS)' \
+				TOP="$(TOP)" \
 				link_o.$(SHLIB_TARGET); \
 		done; \
 	else \
Index: openssl-0.9.8g/test/Makefile
===================================================================
--- openssl-0.9.8g.orig/test/Makefile	2008-01-02 14:45:39.000000000 +0100
+++ openssl-0.9.8g/test/Makefile	2008-01-02 15:02:18.000000000 +0100
@@ -317,6 +317,7 @@
 	$(MAKE) -f $(TOP)/Makefile.shared -e \
 		APPNAME=$$target$(EXE_EXT) OBJECTS="$$target.o" \
 		LIBDEPS="$(PEX_LIBS) $$LIBRARIES $(EX_LIBS)" \
+		TOP="$(TOP)" \
 		link_app.$${shlib_target}
 
 $(RSATEST)$(EXE_EXT): $(RSATEST).o $(DLIBCRYPTO)
